name: Update CHANGELOG

on:
  push:
    tags:
      - "v*"

jobs:
  update-changelog:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Get latest tag
        id: get_latest_tag
        run: echo "LATEST_TAG=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Get previous tag
        id: get_previous_tag
        run: |
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 ${{ steps.get_latest_tag.outputs.LATEST_TAG }}^ 2>/dev/null || echo "")
          echo "PREVIOUS_TAG=$PREVIOUS_TAG" >> $GITHUB_OUTPUT

      - name: Generate changelog
        id: generate_changelog
        run: |
          if [ -z "${{ steps.get_previous_tag.outputs.PREVIOUS_TAG }}" ]; then
            # 첫 번째 태그인 경우
            git log --pretty=format:"* %s (%h) @%an" ${{ steps.get_latest_tag.outputs.LATEST_TAG }} >> temp_changelog.txt
          else
            # 이전 태그가 있는 경우
            git log --pretty=format:"* %s (%h) @%an" ${{ steps.get_previous_tag.outputs.PREVIOUS_TAG }}..${{ steps.get_latest_tag.outputs.LATEST_TAG }} >> temp_changelog.txt
          fi

      - name: Update CHANGELOG.md
        run: |
          echo "## ${{ steps.get_latest_tag.outputs.LATEST_TAG }} ($(date +'%Y-%m-%d'))" > new_changelog.txt
          echo "" >> new_changelog.txt
          cat temp_changelog.txt >> new_changelog.txt
          echo "" >> new_changelog.txt

          if [ -f CHANGELOG.md ]; then
            cat CHANGELOG.md >> new_changelog.txt
          fi

          mv new_changelog.txt CHANGELOG.md

      - name: Update version.ts
        run: |
          # 태그에서 'v' 제거
          VERSION=${GITHUB_REF#refs/tags/v}
          # version.ts 파일 업데이트
          echo "const APP_VERSION = \"$VERSION\";" > version.ts

      - name: Configure Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          # 현재 태그가 가리키는 커밋의 해시를 가져옴
          COMMIT_HASH=$(git rev-parse HEAD)
          # main 브랜치로 전환
          git checkout main
          # 변경사항을 main 브랜치에 적용
          git checkout $COMMIT_HASH -- CHANGELOG.md version.ts

      - name: Commit and push changes
        run: |
          git add CHANGELOG.md version.ts
          git commit -m "docs: update CHANGELOG.md and version.ts for ${{ steps.get_latest_tag.outputs.LATEST_TAG }}"
          git push origin main
