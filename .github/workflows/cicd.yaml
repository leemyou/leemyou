name: üì¶ Update Changelog and version.ts on Tag

on:
  push:
    tags:
      - "*"

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: üîÑ Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: üí° Extract version from tag
        id: tag
        run: |
          TAG_NAME=${GITHUB_REF##*/}
          VERSION=${TAG_NAME#v}
          echo "tag_version=$VERSION" >> $GITHUB_OUTPUT

      - name: üìù Update version.ts
        run: |
          VERSION=${{ steps.tag.outputs.tag_version }}
          sed -i -E 's/(const APP_VERSION\s*=\s*")[0-9]+\.[0-9]+\.[0-9]+(")/\1'"$VERSION"'\2/' version.ts
          echo "‚úÖ version.ts updated to $VERSION"

      - name: üìÑ Generate CHANGELOG.md
        uses: TriPSs/conventional-changelog-action@v5
        with:
          token: ${{ secrets.GH_PAT }}
          futureRelease: v${{ steps.tag.outputs.tag_version }}
          output: CHANGELOG.md
          output-file: CHANGELOG.md
          skip-version-file: true
          skip-commit: true
          skip-tag: true

      - name: ‚úÖ Commit and Push changes
        run: |
          git config user.name "leemyou"
          git config user.email "limhyeon0809@gmail.com"

          git add version.ts CHANGELOG.md
          git commit -m "chore(release): v${{ steps.tag.outputs.tag_version }}"
          git push origin HEAD:refs/heads/${{ github.event.repository.default_branch }}
