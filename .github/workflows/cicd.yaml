name: ğŸ“¦ Update Changelog on Tag

on:
  push:
    tags:
      - "*"

permissions:
  contents: write

jobs:
  update-changelog:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ”„ Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # íƒœê·¸ ë¹„êµë¥¼ ìœ„í•´ ì „ì²´ ì´ë ¥ í•„ìš”

      - name: ğŸ” Check version.ts matches tag
        id: version_check
        run: |
          TAG_NAME=${GITHUB_REF##*/}
          TAG_NAME=${TAG_NAME#v}  # ì ‘ë‘ì‚¬ 'v' ì œê±°
          echo "Current tag: $TAG_NAME"

          VERSION_FILE="./version.ts"
          if [ ! -f "$VERSION_FILE" ]; then
            echo "âŒ version.ts íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤!"
            exit 1
          fi

          FILE_VERSION=$(grep -oP 'const APP_VERSION\s*=\s*"\K[0-9]+\.[0-9]+\.[0-9]+' "$VERSION_FILE")

          echo "version.ts: $FILE_VERSION"

          if [ "$TAG_NAME" != "$FILE_VERSION" ]; then
            echo "âŒ ë²„ì „ì´ ë‹¤ë¦…ë‹ˆë‹¤! ë²„ì „ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤."
            sed -i -E 's/(const APP_VERSION\s*=\s*")[0-9]+\.[0-9]+\.[0-9]+(")/\1'"$TAG_NAME"'\2/' "$VERSION_FILE"
          fi

      - name: ğŸ§  Get previous tag
        id: previous_tag
        run: |
          PREV_TAG=$(git tag --sort=-creatordate | grep -v "${GITHUB_REF##*/}" | head -n 1)
          echo "PREV_TAG=$PREV_TAG" >> $GITHUB_ENV
          echo "LATEST_TAG=${GITHUB_REF##*/}" >> $GITHUB_ENV
          echo "FIRST_TAG=$PREV_TAG" >> $GITHUB_ENV

      - name: âœï¸ Generate changelog
        uses: janheinrichmerker/action-github-changelog-generator@v2.4
        with:
          token: ${{ secrets.GH_PAT }}
          futureRelease: ${{ github.event.release.tag_name || env.LATEST_TAG }}
          output: CHANGELOG.md
          sinceTag: ${{ env.FIRST_TAG }} # v1.0.0ê³¼ ê°™ì€ êµ¬ì²´ì ì¸ ë²„ì „ íƒœê·¸
          # excludeTags: "v1,v2"  # ëª…ì‹œì ìœ¼ë¡œ ì œì™¸í•  íƒœê·¸
          excludeTagsRegex: "^v[0-9]$" # ì •ê·œì‹ìœ¼ë¡œ v1, v2, v3... íŒ¨í„´ ì œì™¸
          prLabel: "new Features"
          simpleList: true
          headerLabel: "# PLOT RELEASE NOTE"

      - name: Git Commit and Push
        uses: somaz94/go-git-commit-action@v1
        with:
          repository: ${{ github.repository }}
          branch: main
          commit_message: "Release version ${VERSION}"
          user_email: "limhyeon0809@gmail.com"
          user_name: "leemyou"
          file_pattern: "CHANGELOG.md"
