name: 📦 Update Changelog on Tag

on:
  push:
    tags:
      - "*"

jobs:
  update-changelog:
    runs-on: ubuntu-latest

    steps:
      - name: 🔄 Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # 태그 비교를 위해 전체 이력 필요

      - name: 🔍 Check version.ts matches tag
        id: version_check
        run: |
          TAG_NAME=${GITHUB_REF##*/}
          TAG_NAME=${TAG_NAME#v}  # 접두사 'v' 제거
          echo "Current tag: $TAG_NAME"

          VERSION_FILE="./version.ts"
          if [ ! -f "$VERSION_FILE" ]; then
            echo "❌ version.ts 파일이 존재하지 않습니다!"
            exit 1
          fi

          FILE_VERSION=$(grep -oP 'const APP_VERSION\s*=\s*"\K[0-9]+\.[0-9]+\.[0-9]+' "$VERSION_FILE")

          echo "version.ts: $FILE_VERSION"

          if [ "$TAG_NAME" != "$FILE_VERSION" ]; then
            echo "❌ 버전이 다릅니다! 버전을 확인해주세요!"
            exit 1
          fi

      - name: 🧠 Get previous tag
        id: previous_tag
        run: |
          PREV_TAG=$(git tag --sort=-creatordate | grep -v "${GITHUB_REF##*/}" | head -n 1)
          echo "tag=$PREV_TAG" >> $GITHUB_OUTPUT

      - name: 📄 Generate and prepend changelog
        run: |
          CURRENT_TAG=${GITHUB_REF##*/}
          PREVIOUS_TAG=${{ steps.previous_tag.outputs.tag }}

          echo "Generating changelog from $PREVIOUS_TAG to $CURRENT_TAG"

          echo "## $CURRENT_TAG - $(date '+%Y-%m-%d')" > new_changelog.md
          echo "" >> new_changelog.md
          git log "$PREVIOUS_TAG..$CURRENT_TAG" --pretty=format:"- %s (%an)" >> new_changelog.md
          echo "" >> new_changelog.md

          # 기존 CHANGELOG.md 없으면 빈 파일 생성
          [ -f CHANGELOG.md ] || touch CHANGELOG.md
          cat CHANGELOG.md >> new_changelog.md
          mv new_changelog.md CHANGELOG.md

      - name: ✅ Commit updated CHANGELOG.md
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          git config --global user.name "leemyou"
          git config --global user.email "limhyeon0809@gmail.com"

          git remote set-url origin https://x-access-token:${GH_PAT}@github.com/${{ github.repository }}

          git add CHANGELOG.md
          git commit -m "docs(changelog): update for ${{ github.ref_name }}" || echo "No changes to commit"
          git push origin HEAD
